<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    {% include "header.html" %}
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container">
        <h4>Topic Area</h4>
        <div class="row">
            <div readonly id="chat-log" cols="100" rows="20"></div><br>
{#            <textarea readonly id="chat-log" cols="100" rows="20"></textarea><br>#}
        </div>
        <div class="row my-3">
            <div class="col-11">
                <input id="chat-message-input" type="text" size="100"><br>
            </div>
            <div class="col-1 justify-content-end d-flex">
                <input type="file" id="uploadFile" style="display: none;" />
                <input type="button" value="Upload" onclick="document.getElementById('uploadFile').click();" />
                <input class="btn btn-primary ml-2" id="chat-message-submit" type="button" value="Send">
            </div>
        </div>
        {{ room_name|json_script:"room-name" }}
        <br/>
        <br/>
        <label>Multiselect: <input type="text" id="multiselect"></label>
        <button type="button" id="submit_multiselect">Submit</button>
    </div>
    <script src="multiselect.js" type="text/javascript"></script>
    <link rel="stylesheet" href="multiselect.css">
    <script>
        const mySellect = sellect("#multiselect", {
            originList: ['banana', 'apple', 'pineapple', 'papaya', 'grape', 'orange', 'grapefruit', 'guava', 'watermelon', 'melon'],
            destinationList: ['banana', 'papaya', 'grape', 'orange', 'guava']
        });
        mySellect.init();

        function toBase64 (file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            })
        } 

        document.querySelector('#submit_multiselect').onclick = function() {
            console.log(mySellect.getSelected())
        };

        document.querySelector('#chat-message-submit').onclick = async function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const file = document.getElementById("uploadFile").files[0];
            const message = messageInputDom.value;
            
            const fileInBase64 = await toBase64(file)
            chatSocket.send(JSON.stringify({
                'message': message,
                file: fileInBase64
                // 'roomName': roomName,
            }));
            messageInputDom.value = '';
        }

    </script>
</body>
<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        {#document.querySelector('#chat-log').value += (data.message + '\n');#}
        document.querySelector('#chat-log').innerHTML +=
            "<div class='m-2 p-1 rounded w-50' style='background: lightgrey'>"+
            (data.message + '\n')+
            "<button type='button' onclick='upvote_counter("+(data.id)+")' class='btn btn-success btn-sm mx-2'>&#8593<span id='u"+(data.id)+"' class='badge badge-dark badge-sm'>"+(data.upvote)+"</span></button>"+
            "<button type='button' onclick='downvote_counter("+(data.id)+")' class='btn btn-danger btn-sm mx-2'>&#8595<span id='d"+(data.id)+"' class='badge badge-dark badge-sm'>"+(data.downvote)+"</span></button>"+
            "</div>";
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'roomName': roomName
        }));
        messageInputDom.value = '';
    };

</script>
<script>
    const divHTML = document.getElementById('chat-log');
    for (let i = 0; i < {{ chat_messages|safe }}.length; i++) {
      {#textarea.innerText += {{chat_messages|safe}}[i]+ "\r\n";#}
      divHTML.innerHTML +=
          "<div class='m-2 p-1 rounded w-50' style='background: lightgrey'>"+
          {{chat_messages|safe}}[i][1] +
          {#"<button type='button' onclick='document.getElementById("+{{chat_messages|safe}}[i][0]+").innerHTML = parseInt(document.getElementById("+{{chat_messages|safe}}[i][0]+").textContent)+1;upvote_counter("+{{chat_messages|safe}}[i][0]+")' name='upvote' value='upvote' onclick='upvote_counter("+i+")' class='btn btn-success btn-sm mx-2'>&#8593<span id="+{{chat_messages|safe}}[i][0]+" class='badge badge-dark badge-sm'>"+{{chat_messages|safe}}[i][2]+"</span></button>"+#}
          "<button type='button' onclick='upvote_counter("+{{chat_messages|safe}}[i][0]+")' class='btn btn-success btn-sm mx-2'>&#8593<span id='u"+{{chat_messages|safe}}[i][0]+"' class='badge badge-dark badge-sm'>"+{{chat_messages|safe}}[i][2]+"</span></button>"+
          "<button type='button' onclick='downvote_counter("+{{chat_messages|safe}}[i][0]+")' class='btn btn-danger btn-sm mx-2'>&#8595<span id='d"+{{chat_messages|safe}}[i][0]+"' class='badge badge-dark badge-sm'>"+{{chat_messages|safe}}[i][3]+"</span></button>"+
          "</div>\r\n";
    }

    {#scroll to bottom#}
    {#textarea.scrollTop = textarea.scrollHeight#}
</script>
<script>
    const predictiveOptions = [{"tag": "Alfalfa"},{"tag": "Almond"},{"tag": "Apple"}]
</script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
    function upvote_counter(chat_id) {
        {#window.open(url);#}
        var chatid = 'u'+chat_id;
        console.log(chatid)

        $.post({% url 'voting' %}, {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            chat_id: chat_id,
            voting_type: 'upvote',
        }, function (data) {
            console.log("upvoted!");
            if (data.status) {
                document.getElementById(chatid).innerHTML = parseInt(document.getElementById(chatid).textContent)+1
            }
        })
    }
    function downvote_counter(chat_id) {
        {#window.open(url);#}
        var chatid = 'd'+chat_id;
        console.log(chatid)

        $.post({% url 'voting' %}, {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            chat_id: chat_id,
            voting_type: 'downvote',
        }, function (data) {
            console.log("downvoted!");
            if (data.status) {
                document.getElementById(chatid).innerHTML = parseInt(document.getElementById(chatid).textContent)+1
            }
        })
    }
</script>
</html>